{
  "version": 3,
  "sources": ["../../../../app/routes/settings+/profile.password.tsx"],
  "sourcesContent": ["// REMIX HMR BEGIN\nif (!window.$RefreshReg$ || !window.$RefreshSig$ || !window.$RefreshRuntime$) {\n  console.warn('remix:hmr: React Fast Refresh only works when the Remix compiler is running in development mode.');\n} else {\n  var prevRefreshReg = window.$RefreshReg$;\n  var prevRefreshSig = window.$RefreshSig$;\n  window.$RefreshReg$ = (type, id) => {\n    window.$RefreshRuntime$.register(type, \"\\\"app/routes/settings+/profile.password.tsx\\\"\" + id);\n  }\n  window.$RefreshSig$ = window.$RefreshRuntime$.createSignatureFunctionForTransform;\n}\nvar _s = $RefreshSig$();\nimport * as __hmr__ from \"remix:hmr\";\nif (import.meta) {\n  import.meta.hot = __hmr__.createHotContext(\n  //@ts-expect-error\n  \"app/routes/settings+/profile.password.tsx\");\n  import.meta.hot.lastModified = \"1713999714261.0496\";\n}\n// REMIX HMR END\n\nimport { getFormProps, getInputProps, useForm } from \"@conform-to/react\";\nimport { getZodConstraint, parseWithZod } from \"@conform-to/zod\";\nimport { json, redirect } from \"@remix-run/node\";\nimport { Form, Link, useActionData } from \"@remix-run/react\";\nimport { z } from \"zod\";\nimport { ErrorList, Field } from \"#app/components/forms.tsx\";\nimport { Button } from \"#app/components/ui/button.tsx\";\nimport { Icon } from \"#app/components/ui/icon.tsx\";\nimport { StatusButton } from \"#app/components/ui/status-button.tsx\";\nimport { getPasswordHash, requireUserId, verifyUserPassword } from \"#app/utils/auth.server.ts\";\nimport { prisma } from \"#app/utils/db/db.server.ts\";\nimport { useIsPending } from \"#app/utils/misc.tsx\";\nimport { redirectWithToast } from \"#app/utils/toast.server.ts\";\nimport { PasswordSchema } from \"#app/utils/user-validation.ts\";\nexport const handle = {\n  breadcrumb: <Icon name=\"dots-horizontal\">Password</Icon>\n};\nconst ChangePasswordForm = z.object({\n  currentPassword: PasswordSchema,\n  newPassword: PasswordSchema,\n  confirmNewPassword: PasswordSchema\n}).superRefine(_c = ({\n  confirmNewPassword,\n  newPassword\n}, ctx) => {\n  if (confirmNewPassword !== newPassword) {\n    ctx.addIssue({\n      path: [\"confirmNewPassword\"],\n      code: z.ZodIssueCode.custom,\n      message: \"The passwords must match\"\n    });\n  }\n});\n_c2 = ChangePasswordForm;\nasync function requirePassword(userId) {\n  const password = await prisma.password.findUnique({\n    select: {\n      userId: true\n    },\n    where: {\n      userId\n    }\n  });\n  if (!password) {\n    throw redirect(\"/settings/profile/password/create\");\n  }\n}\nexport async function loader({\n  request\n}) {\n  const userId = await requireUserId(request);\n  await requirePassword(userId);\n  return json({});\n}\nexport async function action({\n  request\n}) {\n  const userId = await requireUserId(request);\n  await requirePassword(userId);\n  const formData = await request.formData();\n  const submission = await parseWithZod(formData, {\n    async: true,\n    schema: ChangePasswordForm.superRefine(async ({\n      currentPassword,\n      newPassword\n    }, ctx) => {\n      if (currentPassword && newPassword) {\n        const user = await verifyUserPassword({\n          id: userId\n        }, currentPassword);\n        if (!user) {\n          ctx.addIssue({\n            path: [\"currentPassword\"],\n            code: z.ZodIssueCode.custom,\n            message: \"Incorrect password.\"\n          });\n        }\n      }\n    })\n  });\n  if (submission.status !== \"success\") {\n    return json({\n      result: submission.reply({\n        hideFields: [\"currentPassword\", \"newPassword\", \"confirmNewPassword\"]\n      })\n    }, {\n      status: submission.status === \"error\" ? 400 : 200\n    });\n  }\n  const {\n    newPassword\n  } = submission.value;\n  await prisma.user.update({\n    select: {\n      username: true\n    },\n    where: {\n      id: userId\n    },\n    data: {\n      password: {\n        update: {\n          hash: await getPasswordHash(newPassword)\n        }\n      }\n    }\n  });\n  return redirectWithToast(`/settings/profile`, {\n    type: \"success\",\n    title: \"Password Changed\",\n    description: \"Your password has been changed.\"\n  }, {\n    status: 302\n  });\n}\nexport default function ChangePasswordRoute() {\n  _s();\n  const actionData = useActionData();\n  const isPending = useIsPending();\n  const [form, fields] = useForm({\n    id: \"password-change-form\",\n    constraint: getZodConstraint(ChangePasswordForm),\n    lastResult: actionData?.result,\n    onValidate({\n      formData\n    }) {\n      return parseWithZod(formData, {\n        schema: ChangePasswordForm\n      });\n    },\n    shouldRevalidate: \"onBlur\"\n  });\n  return <Form method=\"POST\" {...getFormProps(form)} className=\"mx-auto max-w-md\">\n      <Field errors={fields.currentPassword.errors} inputProps={{\n      ...getInputProps(fields.currentPassword, {\n        type: \"password\"\n      }),\n      autoComplete: \"current-password\"\n    }} labelProps={{\n      children: \"Current Password\"\n    }} />\n      <Field errors={fields.newPassword.errors} inputProps={{\n      ...getInputProps(fields.newPassword, {\n        type: \"password\"\n      }),\n      autoComplete: \"new-password\"\n    }} labelProps={{\n      children: \"New Password\"\n    }} />\n      <Field errors={fields.confirmNewPassword.errors} inputProps={{\n      ...getInputProps(fields.confirmNewPassword, {\n        type: \"password\"\n      }),\n      autoComplete: \"new-password\"\n    }} labelProps={{\n      children: \"Confirm New Password\"\n    }} />\n      <ErrorList errors={form.errors} id={form.errorId} />\n      <div className=\"grid w-full grid-cols-2 gap-6\">\n        <Button asChild variant=\"secondary\">\n          <Link to=\"..\">Cancel</Link>\n        </Button>\n        <StatusButton status={isPending ? \"pending\" : form.status ?? \"idle\"} type=\"submit\">\n          Change Password\n        </StatusButton>\n      </div>\n    </Form>;\n}\n_s(ChangePasswordRoute, \"qg6D+LQiyyBwoKKZlQs9OeApyZ8=\", false, function () {\n  return [useActionData, useIsPending, useForm];\n});\n_c3 = ChangePasswordRoute;\nvar _c, _c2, _c3;\n$RefreshReg$(_c, \"ChangePasswordForm$z\\n  .object({\\n    currentPassword: PasswordSchema,\\n    newPassword: PasswordSchema,\\n    confirmNewPassword: PasswordSchema,\\n  })\\n  .superRefine\");\n$RefreshReg$(_c2, \"ChangePasswordForm\");\n$RefreshReg$(_c3, \"ChangePasswordRoute\");\n\nwindow.$RefreshReg$ = prevRefreshReg;\nwindow.$RefreshSig$ = prevRefreshSig;"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAuBA,kBAA+B;AAO/B,yBAAmE;AACnE,uBAAuB;AAEvB,0BAAkC;AAGpB;AAnCd,IAAI,CAAC,OAAO,gBAAgB,CAAC,OAAO,gBAAgB,CAAC,OAAO,kBAAkB;AAC5E,UAAQ,KAAK,kGAAkG;AACjH,OAAO;AACD,mBAAiB,OAAO;AACxB,mBAAiB,OAAO;AAC5B,SAAO,eAAe,CAAC,MAAM,OAAO;AAClC,WAAO,iBAAiB,SAAS,MAAM,gDAAkD,EAAE;AAAA,EAC7F;AACA,SAAO,eAAe,OAAO,iBAAiB;AAChD;AANM;AACA;AAMN,IAAI,KAAK,aAAa;AAEtB,IAAI,aAAa;AACf,cAAY,MAAc;AAAA;AAAA,IAE1B;AAAA,EAA2C;AAC3C,cAAY,IAAI,eAAe;AACjC;AAiBO,IAAM,SAAS;AAAA,EACpB,YAAY,mDAAC,QAAK,MAAK,mBAAkB,wBAA7B;AAAA;AAAA;AAAA;AAAA,GAAqC;AACnD;AACA,IAAM,qBAAqB,EAAE,OAAO;AAAA,EAClC,iBAAiB;AAAA,EACjB,aAAa;AAAA,EACb,oBAAoB;AACtB,CAAC,EAAE,YAAY,KAAK,CAAC;AAAA,EACnB;AAAA,EACA;AACF,GAAG,QAAQ;AACT,MAAI,uBAAuB,aAAa;AACtC,QAAI,SAAS;AAAA,MACX,MAAM,CAAC,oBAAoB;AAAA,MAC3B,MAAM,EAAE,aAAa;AAAA,MACrB,SAAS;AAAA,IACX,CAAC;AAAA,EACH;AACF,CAAC;AACD,MAAM;AAkFS,SAAR,sBAAuC;AAC5C,KAAG;AACH,QAAM,aAAa,cAAc;AACjC,QAAM,YAAY,aAAa;AAC/B,QAAM,CAAC,MAAM,MAAM,IAAI,QAAQ;AAAA,IAC7B,IAAI;AAAA,IACJ,YAAY,iBAAiB,kBAAkB;AAAA,IAC/C,YAAY,YAAY;AAAA,IACxB,WAAW;AAAA,MACT;AAAA,IACF,GAAG;AACD,aAAO,aAAa,UAAU;AAAA,QAC5B,QAAQ;AAAA,MACV,CAAC;AAAA,IACH;AAAA,IACA,kBAAkB;AAAA,EACpB,CAAC;AACD,SAAO,mDAAC,QAAK,QAAO,QAAQ,GAAG,aAAa,IAAI,GAAG,WAAU,oBACzD;AAAA,uDAAC,SAAM,QAAQ,OAAO,gBAAgB,QAAQ,YAAY;AAAA,MAC1D,GAAG,cAAc,OAAO,iBAAiB;AAAA,QACvC,MAAM;AAAA,MACR,CAAC;AAAA,MACD,cAAc;AAAA,IAChB,GAAG,YAAY;AAAA,MACb,UAAU;AAAA,IACZ,KAPE;AAAA;AAAA;AAAA;AAAA,WAOC;AAAA,IACD,mDAAC,SAAM,QAAQ,OAAO,YAAY,QAAQ,YAAY;AAAA,MACtD,GAAG,cAAc,OAAO,aAAa;AAAA,QACnC,MAAM;AAAA,MACR,CAAC;AAAA,MACD,cAAc;AAAA,IAChB,GAAG,YAAY;AAAA,MACb,UAAU;AAAA,IACZ,KAPE;AAAA;AAAA;AAAA;AAAA,WAOC;AAAA,IACD,mDAAC,SAAM,QAAQ,OAAO,mBAAmB,QAAQ,YAAY;AAAA,MAC7D,GAAG,cAAc,OAAO,oBAAoB;AAAA,QAC1C,MAAM;AAAA,MACR,CAAC;AAAA,MACD,cAAc;AAAA,IAChB,GAAG,YAAY;AAAA,MACb,UAAU;AAAA,IACZ,KAPE;AAAA;AAAA;AAAA;AAAA,WAOC;AAAA,IACD,mDAAC,aAAU,QAAQ,KAAK,QAAQ,IAAI,KAAK,WAAzC;AAAA;AAAA;AAAA;AAAA,WAAkD;AAAA,IAClD,mDAAC,SAAI,WAAU,iCACb;AAAA,yDAAC,UAAO,SAAO,MAAC,SAAQ,aACtB,6DAAC,QAAK,IAAG,MAAK,sBAAd;AAAA;AAAA;AAAA;AAAA,aAAoB,KADtB;AAAA;AAAA;AAAA;AAAA,aAEA;AAAA,MACA,mDAAC,gBAAa,QAAQ,YAAY,YAAY,KAAK,UAAU,QAAQ,MAAK,UAAS,+BAAnF;AAAA;AAAA;AAAA;AAAA,aAEA;AAAA,SANF;AAAA;AAAA;AAAA;AAAA,WAOA;AAAA,OAjCG;AAAA;AAAA;AAAA;AAAA,SAkCL;AACJ;AACA,GAAG,qBAAqB,gCAAgC,OAAO,WAAY;AACzE,SAAO,CAAC,eAAe,cAAc,OAAO;AAC9C,CAAC;AACD,MAAM;AACN,IAAI;AAAJ,IAAQ;AAAR,IAAa;AACb,aAAa,IAAI,0KAA0K;AAC3L,aAAa,KAAK,oBAAoB;AACtC,aAAa,KAAK,qBAAqB;AAEvC,OAAO,eAAe;AACtB,OAAO,eAAe;",
  "names": []
}
